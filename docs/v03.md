# v03 — NeuralPulse Core Spine

Dev log for the InfoChannel architecture rewrite.

## Slice 1: Core types + AdapterRegistry + RssAdapter + Stores + MCP tools

**Status: DONE**

Replaced v01's flat RSS-only code with the full InfoChannel architecture:

- `core/types.ts` — NormalizedItem, InfoChannel, ChannelAdapter, SyncState, FeedQuery
- `core/adapter-registry.ts` — pluggable adapter map with `describeAll()` for introspection
- `core/feed-service.ts` — FeedService orchestrator (getFeed, CRUD, introspection)
- `core/sync-coordinator.ts` — on-demand sync with per-channel staleness/TTL, dedup via mutex
- `stores/channel-store.ts` — JSON-backed ChannelStore with atomic writes
- `stores/item-store.ts` — in-memory ItemStore with query/filter/sort
- `stores/sync-state-store.ts` — JSON-backed SyncState persistence
- `adapters/rss.ts` — RssAdapter (validate + sync via rss-parser)
- `mcp/tools.ts` — 7 MCP tools: get_feed, get_channel_types, list/create/update/delete_channel, sync_channel
- `mcp/render.ts` — text rendering for feed items, channel types, channel list

### MCP tools registered
- `get_feed` — query feed with filters (channel_ids, channel_types, tags, query, since, limit)
- `get_channel_types` — introspection of registered adapter types + config schemas
- `list_channels` — list configured channels with sync status
- `create_channel` — validate + persist + initial sync
- `update_channel` — partial update
- `delete_channel` — remove + clean items
- `sync_channel` — force refresh

### Smoke test results
- Channel types introspection: RSS adapter self-describes correctly
- Create channel: auto-extracts display name from feed ("Simon Willison's Weblog")
- List channels: shows channel with sync status
- Get feed: returns 30 items sorted newest-first
- Query filter: substring match on title/snippet works
- Tag filter: works through channel tags
- Sync: idempotent re-sync works
- All 7 tests passed, 30 items ingested from simonwillison.net in ~1.3s

## Slice 2: SyncCoordinator background loop + concurrency + lifecycle

**Status: DONE**

Upgraded SyncCoordinator from simple on-demand to full production-grade:

- **Background sync loop**: configurable interval (default 30s), scans enabled channels, syncs stale ones
- **Lifecycle**: `startBackgroundSync()` / `stopBackgroundSync()` — called from server bootstrap
- **Concurrency control**: counting semaphore with global cap (8) + per-adapter cap (e.g. RSS=10, GitHub=2)
- **Rate budget tracking**: per-adapter budget from response headers, defers sync when exhausted
- **Exponential backoff**: failures increase retry delay (capped at 30 min), circuit-breaker via `nextRetryAfter`
- **Per-channel mutex**: prevents concurrent syncs of same channel (background tick + on-demand race)

### Tests (11 total, all pass)
- Tests 1-8: same as Slice 1, still work
- Test 9: multi-channel feed (RSS + RSS), items merge correctly sorted by date
- Test 10: delete_channel removes channel + its cached items
- Test 11: background sync lifecycle start/stop

## Slice 3: YouTubePodcastAdapter

**Status: DONE**

- Uses YouTube Atom feed (`/feeds/videos.xml?channel_id=X`) via `rss-parser`
- Cursor-based incremental sync: tracks `lastPublishedAt`, skips already-seen items
- Extracts video ID from link, builds canonical YouTube URLs
- `meta: { videoId }` for each item
- Self-describes config: `channelId` (required), `handle` (optional), `ttlMinutes` (optional)
- TTL: 15 min, maxConcurrency: 5

### Tests (15 total, all pass)
- Test 12: `get_channel_types` now returns 2 types (rss + youtube_podcast)
- Test 13: created 3Blue1Brown channel, ingested 15 videos
- Test 14: `get_feed` filtered by `channel_types: ["youtube_podcast"]` returns YouTube items
- Test 15: mixed feed merges RSS + YouTube items sorted by date

## Slice 4: GitHubTrendsAdapter

**Status: DONE**

- Polls GitHub REST API for configurable event types: `releases`, `commits`, `pulls`, `issues`
- Per-repo, per-event ETag cursors for conditional GET (304 = no work)
- Human-readable titles: "Release v1.8.2 in owner/repo", "PR #431 merged: Fix parser"
- Rich `meta`: `{ kind, repo, author, labels, action }`
- Rate limit tracking: reads `x-ratelimit-remaining` / `x-ratelimit-reset`, reports to SyncCoordinator
- Auth: resolves PAT from `credentialKey` env var or `GITHUB_TOKEN` fallback
- Self-describes 4 config fields: `repos` (required), `events`, `credentialKey`, `ttlMinutes`
- TTL: 10 min, maxConcurrency: 2

### Tests (19 total, all pass)
- Test 16: `get_channel_types` now returns 3 types
- Test 17: created channel for `modelcontextprotocol/typescript-sdk`, ingested 25 items (commits + releases)
- Test 18: filtered feed by `channel_types: ["github_trends"]` returns GitHub items
- Test 19: all-channel mixed feed pulls from 2+ types (rss, github_trends)

## Slice 5: Cleanup + v02 spec

**Status: DONE**

- Removed v01 legacy files (`src/config.ts`, `src/feeds.ts`)
- Added `/data/` to `.gitignore` (runtime state files)
- Rewrote `README.md` with full v02 architecture, tools, and usage examples
- Wrote `docs/v02.md` spec documenting the architecture as-built
- Final type-check: clean
- Final smoke test: 19 tests, all pass

## Summary

| Metric | Value |
|---|---|
| Source files | 12 (index + 4 core + 3 stores + 3 adapters + 2 mcp) |
| MCP tools | 7 (get_feed, get_channel_types, list/create/update/delete_channel, sync_channel) |
| Channel types | 3 (rss, youtube_podcast, github_trends) |
| Smoke tests | 19 (all pass) |
| Total test runtime | ~2.1s |
| Items ingested per test run | ~70 (30 RSS + 15 YouTube + 25 GitHub)
